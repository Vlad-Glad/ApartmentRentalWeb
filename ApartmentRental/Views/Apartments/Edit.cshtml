@model ApartmentRental.Models.Apartment

@{
    ViewData["Title"] = "Edit apartment";
}

<div class="row justify-content-center">
    <div class="col-lg-7">
        <div class="card app-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h1 class="h4 mb-1">Edit apartment</h1>
                        <div class="app-muted">Update details, address and photos.</div>
                    </div>
                    <a asp-action="Index" class="btn btn-outline-secondary btn-sm app-pill">
                        <i class="bi bi-arrow-left me-1"></i> Back
                    </a>
                </div>

                <form asp-action="Edit" enctype="multipart/form-data">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <input type="hidden" asp-for="Id" />

                    <div class="mb-3">
                        <label asp-for="Title" class="form-label"></label>
                        <input asp-for="Title" class="form-control" />
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Description" class="form-label"></label>
                        <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Price" class="form-label"></label>
                        <div class="input-group">
                            <input asp-for="Price" class="form-control" />
                            <span class="input-group-text">$/month</span>
                        </div>
                        <span asp-validation-for="Price" class="text-danger"></span>
                    </div>

                    <div class="mb-2">
                        <label asp-for="FullAddress" class="form-label"></label>
                        <input asp-for="FullAddress" class="form-control" id="addressInput" />
                        <span asp-validation-for="FullAddress" class="text-danger"></span>

                        <div class="d-flex gap-2 mt-2">
                            <button type="button" id="findOnMapBtn" class="btn btn-outline-secondary app-pill">
                                <i class="bi bi-search me-1"></i> Find address
                            </button>
                            <span class="app-muted small align-self-center">
                                Enter an address and click “Find address” to update coordinates.
                            </span>
                        </div>
                    </div>

                    <div id="create-map" class="border rounded mb-3" style="height: 320px;"></div>

                    @if (Model.Photos != null && Model.Photos.Any())
                    {
                        <div class="mb-3">
                            <div class="fw-semibold mb-2">Current photos</div>
                            <div class="row g-2">
                                @foreach (var photo in Model.Photos)
                                {
                                    <div class="col-4 col-md-3">
                                        <div class="border rounded overflow-hidden" style="height: 110px; display:flex; align-items:center; justify-content:center;">
                                            <img src="@photo.ImageUrl" alt="Apartment photo"
                                                 class="img-fluid" style="max-height:100%; max-width:100%; object-fit:cover;" />
                                        </div>
                                    </div>
                                }
                            </div>
                            <div class="form-text">
                                If you upload new photos, all old photos will be replaced.
                            </div>
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label">New photos</label>
                        <input type="file" name="photos" class="form-control" multiple />
                        <div class="form-text">
                            If you select new photos, all old photos will be replaced.
                        </div>
                    </div>

                    <input type="hidden" asp-for="Latitude" id="Latitude" />
                    <input type="hidden" asp-for="Longitude" id="Longitude" />
                    <input type="hidden" asp-for="City" id="City" />
                    <input type="hidden" id="IsAddressValid" name="IsAddressValid" value="true" />

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary app-pill">
                            <i class="bi bi-check2-circle me-1"></i> Save
                        </button>
                        <a asp-action="Index" class="btn btn-outline-secondary app-pill">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Head {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
}

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <script>
        let editMap;
        let editMarker;

        document.addEventListener("DOMContentLoaded", function () {
            const mapDiv = document.getElementById('create-map');
            const addressInput = document.getElementById('addressInput');
            const validFlag = document.getElementById('IsAddressValid');
            const latInput = document.getElementById('Latitude');
            const lonInput = document.getElementById('Longitude');

            if (!mapDiv || !latInput || !lonInput) return;

            const hasCoords = latInput.value && lonInput.value;
            const lat = hasCoords ? parseFloat(latInput.value) : 49.0;
            const lon = hasCoords ? parseFloat(lonInput.value) : 31.0;

            editMap = L.map('create-map').setView([lat, lon], hasCoords ? 15 : 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(editMap);

            if (hasCoords && !isNaN(lat) && !isNaN(lon)) {
                editMarker = L.marker([lat, lon]).addTo(editMap);
            }

            const btn = document.getElementById('findOnMapBtn');
            if (btn) {
                btn.addEventListener('click', onFindOnMapEdit);
            }

            if (addressInput && validFlag) {
                addressInput.addEventListener('input', () => {
                    validFlag.value = "false";
                    latInput.value = "";
                    lonInput.value = "";
                });
            }
        });

        async function onFindOnMapEdit() {
            const addressInput = document.getElementById('addressInput');
            const validFlag = document.getElementById('IsAddressValid');

            if (!addressInput || !validFlag) return;

            const query = addressInput.value.trim();
            validFlag.value = "false";

            if (!query || query.length < 3) {
                alert("Please enter a valid address (at least 3 characters).");
                return;
            }

            const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&q=${encodeURIComponent(query)}`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Accept-Language': 'en',
                        'User-Agent': 'ApartmentRentalApp/1.0'
                    }
                });

                if (!response.ok) {
                    alert("Geocoding request failed.");
                    return;
                }

                const results = await response.json();
                if (!results || results.length === 0) {
                    alert("No results found. Please refine the address.");
                    return;
                }

                const place = results[0];
                const address = place.address || {};
                const city =
                    address.city ||
                    address.town ||
                    address.village ||
                    address.state ||
                    "";

                document.getElementById("City").value = city;

                if (place.display_name) {
                    addressInput.value = place.display_name;
                }

                const lat = parseFloat(place.lat);
                const lon = parseFloat(place.lon);

                document.getElementById('Latitude').value = lat.toString().replace(',', '.');
                document.getElementById('Longitude').value = lon.toString().replace(',', '.');

                editMap.setView([lat, lon], 15);

                if (editMarker) {
                    editMap.removeLayer(editMarker);
                }
                editMarker = L.marker([lat, lon]).addTo(editMap);

                validFlag.value = "true";
            } catch (err) {
                console.error(err);
                alert("An error occurred while searching for the address.");
                validFlag.value = "false";
            }
        }
    </script>
}
