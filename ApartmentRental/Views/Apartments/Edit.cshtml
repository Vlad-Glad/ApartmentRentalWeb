@model ApartmentRental.Models.Apartment

@{
    ViewData["Title"] = "Edit";
}

<h1>Edit</h1>

<h4>Apartment</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Edit">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <input type="hidden" asp-for="Id" />

            <div class="form-group">
                <label asp-for="Title" class="control-label"></label>
                <input asp-for="Title" class="form-control" />
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Description" class="control-label"></label>
                <input asp-for="Description" class="form-control" />
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Price" class="control-label"></label>
                <div class="input-group">
                    <input asp-for="Price" class="form-control" />
                    <span class="input-group-text">₴</span>
                </div>
                <span asp-validation-for="Price" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="FullAddress" class="control-label"></label>
                <input asp-for="FullAddress" class="form-control" id="addressInput" />
                <span asp-validation-for="FullAddress" class="text-danger"></span>
            </div>

            <div class="mb-2">
                <button type="button" id="findOnMapBtn" class="btn btn-outline-secondary">
                    Пошук адреси
                </button>
            </div>

            <div id="create-map" class="border rounded mb-3" style="height: 300px;"></div>

            <input type="hidden" asp-for="Latitude" id="Latitude" />
            <input type="hidden" asp-for="Longitude" id="Longitude" />
            <input type="hidden" asp-for="City" id="City" />
            <input type="hidden" id="IsAddressValid" name="IsAddressValid" value="true" />

            <div class="form-group mt-2">
                <input type="submit" value="Save" class="btn btn-primary" />
                <a asp-action="Index" class="btn btn-secondary">Back to List</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        let editMap;
        let editMarker;

        document.addEventListener("DOMContentLoaded", function () {
            const mapDiv = document.getElementById('create-map');
            const addressInput = document.getElementById('addressInput');
            const validFlag = document.getElementById('IsAddressValid');
            const latInput = document.getElementById('Latitude');
            const lonInput = document.getElementById('Longitude');

            if (!mapDiv || !latInput || !lonInput) return;

            const hasCoords = latInput.value && lonInput.value;
            const lat = hasCoords ? parseFloat(latInput.value) : 49.0;
            const lon = hasCoords ? parseFloat(lonInput.value) : 31.0;

            editMap = L.map('create-map').setView([lat, lon], hasCoords ? 15 : 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(editMap);

            if (hasCoords && !isNaN(lat) && !isNaN(lon)) {
                editMarker = L.marker([lat, lon]).addTo(editMap);
            }

            const btn = document.getElementById('findOnMapBtn');
            if (btn) {
                btn.addEventListener('click', onFindOnMapEdit);
            }

            if (addressInput && validFlag) {
                addressInput.addEventListener('input', () => {
                    validFlag.value = "false";
                    latInput.value = "";
                    lonInput.value = "";
                });
            }
        });

        async function onFindOnMapEdit() {
            const addressInput = document.getElementById('addressInput');
            const validFlag = document.getElementById('IsAddressValid');

            if (!addressInput || !validFlag) return;

            const query = addressInput.value.trim();
            validFlag.value = "false";

            if (!query || query.length < 3) {
                alert('Введіть коректну адресу (мінімум 3 символи).');
                return;
            }

            const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&q=${encodeURIComponent(query)}`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Accept-Language': 'uk',
                        'User-Agent': 'ApartmentRentalApp/1.0'
                    }
                });

                if (!response.ok) {
                    alert('Помилка запиту до сервісу геокодування.');
                    return;
                }

                const results = await response.json();
                if (!results || results.length === 0) {
                    alert('Нічого не знайдено. Спробуйте уточнити адресу.');
                    return;
                }

                const place = results[0];
                const address = place.address || {};
                const city =
                    address.city ||
                    address.town ||
                    address.village ||
                    address.state ||
                    "";

                document.getElementById("City").value = city;

                if (place.display_name) {
                    addressInput.value = place.display_name;
                }

                const lat = parseFloat(place.lat);
                const lon = parseFloat(place.lon);

                document.getElementById('Latitude').value = lat.toString().replace(',', '.');
                document.getElementById('Longitude').value = lon.toString().replace(',', '.');

                editMap.setView([lat, lon], 15);

                if (editMarker) {
                    editMap.removeLayer(editMarker);
                }
                editMarker = L.marker([lat, lon]).addTo(editMap);

                validFlag.value = "true";
            } catch (err) {
                console.error(err);
                alert('Сталася помилка при пошуку адреси.');
                validFlag.value = "false";
            }
        }
    </script>
}