@{
    ViewData["Title"] = "Apartments on map";
}

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h3 mb-1">Apartments on map</h1>
            <div class="app-muted">Filter by city and explore listings.</div>
        </div>
        <a asp-action="Index" class="btn btn-outline-secondary app-pill">
            <i class="bi bi-arrow-left me-1"></i> Back
        </a>
    </div>

    <div class="card app-card mb-3">
        <div class="card-body">
            <label for="cityFilter" class="form-label">City filter</label>
            <select id="cityFilter" class="form-select">
                <option value="">All cities</option>
            </select>
        </div>
    </div>

    <div class="card app-card">
        <div class="card-body p-0">
            <div id="apartments-map" class="border rounded" style="height: 540px;"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            var map = L.map('apartments-map').setView([49.0, 31.0], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            let markers = [];
            let allApartments = [];

            async function loadApartments() {
                const response = await fetch('/api/apartments?skip=0&limit=100');
                if (!response.ok) {
                    console.error('Failed to load apartments');
                    return;
                }

                const result = await response.json();
                allApartments = result.items || [];

                initCityFilter();
                renderMarkers();
            }

            function initCityFilter() {
                const citySelect = document.getElementById('cityFilter');
                const cities = [...new Set(allApartments
                    .filter(a => a.city)
                    .map(a => a.city))].sort();

                cities.forEach(city => {
                    const opt = document.createElement('option');
                    opt.value = city;
                    opt.textContent = city;
                    citySelect.appendChild(opt);
                });

                citySelect.addEventListener('change', renderMarkers);
            }

            function renderMarkers() {
                markers.forEach(m => map.removeLayer(m));
                markers = [];

                const cityFilter = document.getElementById('cityFilter').value;

                const filtered = allApartments.filter(a => {
                    if (cityFilter && a.city !== cityFilter) return false;
                    return a.latitude != null && a.longitude != null;
                });

                if (filtered.length === 0) return;

                const bounds = [];

                filtered.forEach(a => {
                    const lat = a.latitude;
                    const lng = a.longitude;
                    const marker = L.marker([lat, lng]).addTo(map);

                    const safeTitle = (a.title ?? 'Apartment').toString();
                    const safeCity = (a.city ?? '').toString();
                    const safePrice = a.price ?? '';

                    const popupHtml = `
                        <div>
                            <strong>${safeTitle}</strong><br/>
                            ${safeCity}<br/>
                            Price: ${safePrice} $/month<br/>
                            <a href="/Apartments/Landing/${a.id}">View</a>
                        </div>
                    `;

                    marker.bindPopup(popupHtml);
                    markers.push(marker);
                    bounds.push([lat, lng]);
                });

                if (bounds.length > 0) {
                    map.fitBounds(bounds, { padding: [30, 30] });
                }
            }

            await loadApartments();
        });
    </script>
}
