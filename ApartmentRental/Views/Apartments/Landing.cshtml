@model ApartmentRental.Models.Apartment
@using System.Globalization

@{
    ViewData["Title"] = $"{Model.Title} – rent in {Model.City}";

    var rawDescription = string.IsNullOrWhiteSpace(Model.Description)
        ? $"Apartment for rent in {Model.City}. Price {Model.Price:N0} $ per month."
        : Model.Description;

    var normalized = rawDescription.Replace("\r", " ")
                                  .Replace("\n", " ")
                                  .Trim();

    string metaDescription = normalized.Length > 160
        ? normalized.Substring(0, 157) + "..."
        : normalized;

    ViewData["MetaDescription"] = metaDescription;
    ViewData["MetaImage"] = Model.Photos.FirstOrDefault()?.ImageUrl;
}

<div class="container my-4">
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card app-card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start gap-3">
                        <div>
                            <h1 class="h3 fw-bold mb-1">@Model.Title</h1>
                            <div class="app-muted">@Model.City</div>
                        </div>
                        <div class="text-end">
                            <div class="h4 fw-bold text-primary mb-0">@Model.Price.ToString("N0") $</div>
                            <div class="app-muted">per month</div>
                        </div>
                    </div>
                </div>
            </div>

            @if (Model.Photos != null && Model.Photos.Any())
            {
                <div class="card app-card mb-4">
                    <div class="card-body">
                        <div class="row g-2">
                            @foreach (var photo in Model.Photos)
                            {
                                <div class="col-6 col-md-4">
                                    <img src="@photo.ImageUrl" class="img-fluid rounded" alt="Apartment photo" />
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <div class="card app-card mb-4">
                <div class="card-body">
                    <h2 class="h5 mb-2">Description</h2>
                    <p class="mb-0">
                        @(string.IsNullOrWhiteSpace(Model.Description)
                                                ? "Description will be added soon."
                                                : Model.Description)
                    </p>
                </div>
            </div>

            <div class="card app-card">
                <div class="card-body">
                    <h2 class="h5 mb-2">Location</h2>
                    <div class="mb-3">
                        City: <strong>@Model.City</strong><br />
                        @if (!string.IsNullOrWhiteSpace(Model.FullAddress))
                        {
                            <span>Address: <strong>@Model.FullAddress</strong></span>
                        }
                    </div>

                    <div id="apartment-map" class="border rounded" style="height: 320px;"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="position-sticky" style="top: 80px;">
                <div class="card app-card">
                    <div class="card-body">
                        <h2 class="h5 mb-3">Contacts</h2>

                        <p class="mb-1">
                            <strong>@(Model.Lessor?.FirstName ?? "Lessor") @(Model.Lessor?.LastName)</strong>
                        </p>

                        @if (!string.IsNullOrEmpty(Model.Lessor?.Email))
                        {
                            <p class="mb-1">
                                Email: <a href="mailto:@Model.Lessor.Email">@Model.Lessor.Email</a>
                            </p>
                        }
                        @if (!string.IsNullOrEmpty(Model.Lessor?.PhoneNumber))
                        {
                            <p class="mb-0">
                                Phone: <a href="tel:@Model.Lessor.PhoneNumber">@Model.Lessor.PhoneNumber</a>
                            </p>
                        }

                        <hr />

                        <a asp-action="Index" class="btn btn-outline-secondary w-100 app-pill">
                            <i class="bi bi-arrow-left me-1"></i> Back to list
                        </a>

                        @await Component.InvokeAsync("CurrencyWidget", new { priceUsd = Model.Price })
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const lat = @(Model.Latitude.HasValue
                            ? Model.Latitude.Value.ToString(CultureInfo.InvariantCulture)
                        : "null");

        const lng = @(Model.Longitude.HasValue
                        ? Model.Longitude.Value.ToString(CultureInfo.InvariantCulture)
                        : "null");

        if (lat === null || lng === null) {
            const mapDiv = document.getElementById("apartment-map");
            if (mapDiv) {
                mapDiv.innerHTML = "<div class='p-3 text-muted'>Coordinates are not set.</div>";
            }
            return;
        }

            const map = L.map('apartment-map').setView([lat, lng], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            L.marker([lat, lng])
                .addTo(map)
                .bindPopup(@Json.Serialize(Model.Title));
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (typeof gtag === "function") {
                gtag('event', 'apartment_view', {
                    'apartment_id': '@Model.Id',
                    'city': '@Model.City',
                    'price': @Model.Price,
                    'has_photos': @(Model.Photos != null && Model.Photos.Any() ? "true" : "false")
                });
            }
        });
    </script>
}
